<!DOCTYPE html>
<html lang="en" dir="ltr">


<head>
  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/alasql/0.2.3/alasql.min.js"></script>

</head>
<body>
<!-- Plotly chart will be drawn inside this DIV -->
<div id="myDiv"></div>
  <script>
  /* JAVASCRIPT CODE GOES HERE */
  Plotly.d3.csv('../d3_vis/data/merged_final.csv',
    function(err, rows){
      function unpack(rows, key) {
          return rows.map(function(row) { return row[key]; });
      }
      // select subset for mortality data without duplicates
      var mort_all = alasql('SELECT DISTINCT city, year, latitude, longitude, HTD, CAN, STK, CLD FROM ?', [rows])
      // select subset for pollution
      var pol_all =alasql('SELECT city, date, latitude, longitude, co_aqi_level, o3_aqi_level, no2_aqi_level, so2_aqi_level FROM ?', [rows])

      console.log(pol_all);
      var pol_frame=[]
      var allCityNames = unpack(rows, 'city'),
          allDate = unpack(rows, 'date'),
          allCO = unpack(rows, 'co_aqi_level'),
          all03 = unpack(rows, 'o3_aqi_level'),
          allNO2 = unpack(pol, 'no2_aqi_level'),
          allSO2 = unpack(rows, 'so2_aqi_level'),

          allYear = unpack(rows, 'year'),
          allHTD = unpack(rows,'HTD'),
          allCAN = unpack(rows,'CAN'),
          allSTK = unpack(rows, 'STK'),
          allCLD = unpack(rows, 'CLD'),

          allLat = unpack(rows, 'latitude'),
          allLong = unpack(rows, 'longitude'),

          listofCity = [],
          currentCity=[],
          currentCO = [],
          currentO3=[],
          currentNO2=[],
          currentSO2=[],
          currentCLD = [],
          currentHTD =[],
          currentSTK=[],
          currentCAN=[],

          currentLat=[],
          currentLong=[],

          currentDate = [],
          currentYear = [];

    for (var i = 0; i < allCityNames.length; i++ ){
      if (listofCity.indexOf(allCityNames[i]) === -1 ){
        listofCity.push(allCityNames[i]);
      }
    }

    function getCityData(chosenCity) {
      currentCity=[];
      currentCO = [];
      currentO3=[];
      currentNO2=[];
      currentSO2=[];
      currentCLD = [];
      currentHTD =[];
      currentSTK=[];
      currentCAN=[];
      currentDate = [];
      currentYear = [];
      for (var i = 0 ; i < allCityNames.length ; i++){
        if ( allCityNames[i] === chosenCity ) {
          currentCO.push(allCO[i]);
          currentO3.push(all03[i]);
          currentNO2.push(allNO2[i]);
          currentSO2.push(allSO2[i]);
          currentDate.push(allDate[i]);
          currentCLD.push(allCLD[i]);
          currentHTD.push(allHTD[i]);
          currentSTK.push(allSTK[i]);
          currentCAN.push(allCAN[i]);
          currentYear.push(allYear[i])
        }
      }
    };

    // Pasted code from https://plot.ly/javascript/map-animations/
    var frames = []
    var z = unpack(rows, 'pop') //population
    var locations = unpack(rows, 'abb') //state abbrebation

    var n = 7;
    var j = 51;
    var k = 0;
    var num = 2009
    for (var i = 0; i < n; i++) {
      k++
      j = 51
      j = j*k
      num++
      frames[i] = {data: [{z: [], locations: []}], name: num}
      frames[i].data[0].z = z.slice(0, j);
      frames[i].data[0].locations = locations.slice(0, j);
    }

  var data = [{
        type: 'choropleth',
        locationmode: 'USA-states',
        locations: frames[0].data[0].locations,
        z: frames[0].data[0].z,
        text: frames[0].data[0].locations,
        zauto: false,
        zmin: 500000,
        zmax: 50000000

  }];

  var layout = {
      title: 'USA State Population<br>2010 - 2016',
      geo:{
         scope: 'usa',
         countrycolor: 'rgb(255, 255, 255)',
         showland: true,
         landcolor: 'rgb(217, 217, 217)',
         showlakes: true,
         lakecolor: 'rgb(255, 255, 255)',
         subunitcolor: 'rgb(255, 255, 255)',
         lonaxis: {},
         lataxis: {}
      },
      updatemenus: [{
        x: 0.1,
        y: 0,
        yanchor: "top",
        xanchor: "right",
        showactive: false,
        direction: "left",
        type: "buttons",
        pad: {"t": 87, "r": 10},
        buttons: [{
          method: "animate",
          args: [null, {
            fromcurrent: true,
            transition: {
              duration: 200,
            },
            frame: {
              duration: 500,
              redraw: false
            }
          }],
          label: "Play"
        }, {
          method: "animate",
          args: [
            [null],
            {
              mode: "immediate",
              transition: {
                duration: 0
              },
              frame: {
                duration: 0,
                redraw: false
              }
            }
          ],
          label: "Pause"
        }]
      }],
      sliders: [{
        active: 0,
        steps: [{
          label: "2010",
          method: "animate",
          args: [["2010"], {
              mode: "immediate",
              transition: {duration: 300},
              frame: {duration: 300, "redraw": false}
            }
          ]
        },{
          label: "2011",
          method: "animate",
          args: [["2011"], {
              mode: "immediate",
              transition: {duration: 300},
              frame: {duration: 300, "redraw": false}
            }
          ]
        }, {
          label: "2012",
          method: "animate",
          args: [["2012"], {
              mode: "immediate",
              transition: {duration: 300},
              frame: {duration: 300, "redraw": false}
            }
          ]
        }, {
          label: "2013",
          method: "animate",
          args: [["2013"], {
              mode: "immediate",
              transition: {duration: 300},
              frame: {duration: 300, "redraw": false}
            }
          ]
        }, {
          label: "2014",
          method: "animate",
          args: [["2014"], {
              mode: "immediate",
              transition: {duration: 300},
              frame: {duration: 300, "redraw": false}
            }
          ]
        }, {
          label: "2015",
          method: "animate",
          args: [["2015"], {
              mode: "immediate",
              transition: {duration: 300},
              frame: {duration: 300, "redraw": false}
            }
          ]
        }, {
          label: "2016",
          method: "animate",
          args: [["2016"], {
              mode: "immediate",
              transition: {duration: 300},
              frame: {duration: 300, "redraw": false}
            }
          ]
        }],
        x: 0.1,
        len: 0.9,
        xanchor: "left",
        y: 0,
        yanchor: "top",
        pad: {t: 50, b: 10},
        currentvalue: {
          visible: true,
          prefix: "Year:",
          xanchor: "right",
          font: {
            size: 20,
            color: "#666"
          }
        },
        transition: {
          duration: 300,
          easing: "cubic-in-out"
        }
      }]
  };

  Plotly.plot(myDiv, data, layout).then(function() {
      Plotly.addFrames('myDiv', frames);
    });
  })

  </script>
</body>
</html>


</html>
